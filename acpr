import pandas as pd
from sklearn.model_selection import StratifiedGroupKFold

# 1. Copie du dataframe de travail
df = df_all_trim_final.copy()

# 2. S'assurer que l'identifiant est de type string
df["ID_CONTRAT"] = df["ID_CONTRAT"].astype(str)

# 3. Créer une variable binaire : SINISTRE = 1 s'il y a sinistre, sinon 0
df["SINISTRE_BINARY"] = df["SINISTRE"].astype(int)

# 4. Initialiser la cross-validation stratifiée par contrat
sgkf = StratifiedGroupKFold(n_splits=5, shuffle=True, random_state=42)

# 5. Définir X, y et les groupes (contrats)
X = df.drop(columns=["SINISTRE", "SINISTRE_BINARY", "TRIM_YEAR"])  # ou adapter
y = df["SINISTRE_BINARY"]
groups = df["ID_CONTRAT"]

# 6. Exécuter le split et stocker les index des folds
folds = []

for fold, (train_idx, test_idx) in enumerate(sgkf.split(X, y, groups=groups)):
    print(f"Fold {fold + 1} :")
    print(f"  - Taille train : {len(train_idx)}")
    print(f"  - Taille test  : {len(test_idx)}")
    print(f"  - Proportion sinistres (test) : {y.iloc[test_idx].mean():.4f}")
    
    folds.append((train_idx, test_idx))
